<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial AI Worker - Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #e4e4e7;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            opacity: 0.8;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: clamp(1rem, 3vw, 2rem);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
            gap: clamp(1rem, 2vw, 2rem);
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(30, 30, 46, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .card h3 {
            color: #a78bfa;
            margin-bottom: 1rem;
            font-size: clamp(1rem, 2vw, 1.2rem);
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr));
            gap: clamp(0.75rem, 2vw, 1rem);
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(30, 30, 46, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: scale(1.02);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .metric-value {
            font-size: clamp(1.25rem, 3vw, 2rem);
            font-weight: 700;
            color: #e4e4e7;
            word-break: break-word;
            line-height: 1.2;
        }

        .metric-label {
            color: #a1a1aa;
            margin-top: 0.5rem;
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .controls {
            display: flex;
            gap: clamp(0.5rem, 2vw, 1rem);
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(0.875rem, 1.5vw, 1rem);
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-secondary {
            background: rgba(161, 161, 170, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(161, 161, 170, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(161, 161, 170, 0.3);
            border-color: rgba(161, 161, 170, 0.5);
        }

        .select {
            padding: 0.75rem 1rem;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            font-size: clamp(0.875rem, 1.5vw, 1rem);
            background: rgba(30, 30, 46, 0.6);
            color: #e4e4e7;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .select:hover {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .select:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #a1a1aa;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #6ee7b7;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .chart-container {
            height: 400px;
            margin: 1rem 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .recommendations {
            background: rgba(30, 30, 46, 0.4);
            border-left: 4px solid #a78bfa;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .recommendations h4 {
            color: #a78bfa;
            margin-bottom: 0.5rem;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .recommendations ul {
            list-style-type: none;
        }

        .recommendations li {
            padding: 0.25rem 0;
            color: #d4d4d8;
            font-size: clamp(0.8125rem, 1.5vw, 0.9375rem);
        }

        .recommendations li:before {
            content: "‚Ä¢ ";
            color: #a78bfa;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            overflow-x: auto;
            display: block;
        }

        thead {
            background: rgba(139, 92, 246, 0.1);
        }

        th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #a78bfa;
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
            white-space: nowrap;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            color: #d4d4d8;
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
            word-break: break-word;
        }

        tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        /* Smooth scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.4);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.4);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.6);
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card, .metric-card {
            animation: fadeIn 0.5s ease-out;
        }

        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                gap: 0.5rem;
            }

            .btn, .select {
                width: 100%;
            }

            th, td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .metric-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ Financial AI Worker</h1>
        <p>üìä Portfolio Analysis & Trading Dashboard</p>
        <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="/ai-dashboard" style="color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(167, 139, 250, 0.3); border-radius: 8px; display: inline-block; font-weight: 500; transition: all 0.3s ease; border: 1px solid rgba(167, 139, 250, 0.5);">
                ü§ñ AI Recommendations
            </a>
            <a href="/settings" style="color: white; text-decoration: none; padding: 0.5rem 1rem; background: rgba(167, 139, 250, 0.2); border-radius: 8px; display: inline-block; transition: all 0.3s ease; border: 1px solid rgba(167, 139, 250, 0.3);">
                ‚öôÔ∏è Broker Settings
            </a>
        </div>
    </div>
    
    <div class="container">
        <div class="controls">
            <select id="brokerSelect" class="select">
                <option value="combined">üåê Combined Portfolio</option>
                <option value="zerodha">üáÆüá≥ Zerodha</option>
                <option value="trading212">üåç Trading 212</option>
            </select>
            <select id="accountSelect" class="select" style="display: none;">
                <option value="primary">Primary Account</option>
            </select>
            <select id="currencySelect" class="select">
                <option value="INR">‚Çπ INR (Indian Rupee)</option>
                <option value="EUR">‚Ç¨ EUR (Euro)</option>
            </select>
            <button id="refreshBtn" class="btn">üîÑ Refresh Data</button>
            <div id="exchangeRateDisplay" style="padding: 0.75rem; background: rgba(139, 92, 246, 0.2); border-radius: 8px; font-weight: 500; color: #a78bfa; display: none; border: 1px solid rgba(139, 92, 246, 0.3);">
                üí± 1 EUR = <span id="exchangeRateValue">...</span> INR
            </div>
            <div id="cacheIndicator" style="padding: 0.75rem; background: rgba(239, 68, 68, 0.2); border-radius: 8px; font-weight: 500; color: #fca5a5; display: none; border: 1px solid rgba(239, 68, 68, 0.3);">
                üì¶ Cached Data
            </div>
            <button id="analyzeBtn" class="btn btn-secondary">ü§ñ Analyze Portfolio</button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            ‚è≥ Loading portfolio data...
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>
        
        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be populated here -->
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <h3>üí∞ Portfolio Value</h3>
                <div id="portfolioValueChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>ü•ß Asset Allocation</h3>
                <div id="assetAllocationChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>üìä P&L Analysis</h3>
                <div id="pnlChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>‚öñÔ∏è Risk vs Return</h3>
                <div id="riskReturnChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>üèÜ Top Holdings</h3>
                <div id="topHoldingsChart" class="chart-container"></div>
            </div>

            <div class="card">
                <h3>üìà Portfolio Metrics</h3>
                <div id="metricsDashboard" class="chart-container"></div>
            </div>
        </div>

        <div id="recommendations" class="recommendations" style="display: none;">
            <h4>ü§ñ AI Recommendations</h4>
            <ul id="recommendationsList"></ul>
        </div>
    </div>
    
    <script>
        class FinancialDashboard {
            constructor() {
                this.apiBase = 'http://localhost:8000';
                this.currentBroker = 'combined';
                this.currentCurrency = 'INR';
                this.currentAccount = 'primary';
                this.accounts = { zerodha: [], trading212: [] };
                this.exchangeRate = null;
                this.initializeEventListeners();
                this.loadInitialData();
            }

            initializeEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshData());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzePortfolio());
                document.getElementById('brokerSelect').addEventListener('change', (e) => {
                    this.currentBroker = e.target.value;
                    this.updateAccountSelector();
                    this.refreshData();
                });
                document.getElementById('accountSelect').addEventListener('change', (e) => {
                    this.currentAccount = e.target.value;
                    this.refreshData();
                });
                document.getElementById('currencySelect').addEventListener('change', (e) => {
                    this.currentCurrency = e.target.value;
                    this.refreshData();
                });
            }
            
            async loadInitialData() {
                this.showLoading(true);
                try {
                    await this.loadAccounts();
                    await this.refreshData();
                } catch (error) {
                    this.showError('Failed to load initial data: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadAccounts() {
                try {
                    const response = await axios.get(`${this.apiBase}/accounts/list`);
                    this.accounts = response.data;
                    console.log('Loaded accounts:', this.accounts);
                } catch (error) {
                    console.error('Failed to load accounts:', error);
                }
            }

            updateAccountSelector() {
                const accountSelect = document.getElementById('accountSelect');
                const broker = this.currentBroker;

                // Show account selector only for specific brokers (not combined)
                if (broker === 'zerodha' || broker === 'trading212') {
                    const accountList = this.accounts[broker] || ['primary'];

                    // Clear and populate options
                    accountSelect.innerHTML = '';
                    accountList.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account.charAt(0).toUpperCase() + account.slice(1);
                        accountSelect.appendChild(option);
                    });

                    // Set current account to first available
                    this.currentAccount = accountList[0] || 'primary';
                    accountSelect.value = this.currentAccount;
                    accountSelect.style.display = 'inline-block';
                } else {
                    // Hide account selector for combined view
                    accountSelect.style.display = 'none';
                }
            }
            
            async refreshData() {
                this.showLoading(true);
                try {
                    const portfolioData = await this.fetchPortfolio();
                    this.updateCacheIndicator(portfolioData.is_cached);
                    this.updateMetrics(portfolioData);
                    await this.updateCharts(portfolioData);
                    this.showSuccess('Portfolio data refreshed successfully');
                } catch (error) {
                    this.showError('Failed to refresh data: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async analyzePortfolio() {
                this.showLoading(true);
                try {
                    const analysisData = await this.fetchAnalysis();
                    this.updateRecommendations(analysisData.recommendations);
                    this.showSuccess('Portfolio analysis completed');
                } catch (error) {
                    this.showError('Failed to analyze portfolio: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async fetchPortfolio() {
                let url;

                if (this.currentBroker === 'zerodha' || this.currentBroker === 'trading212') {
                    // Single broker with account selection
                    url = `${this.apiBase}/portfolio/${this.currentBroker}?currency=${this.currentCurrency}&account=${this.currentAccount}`;
                } else {
                    // Combined portfolio (all accounts from all brokers)
                    url = `${this.apiBase}/portfolio/${this.currentBroker}?currency=${this.currentCurrency}`;
                }

                const response = await axios.get(url);

                // Always fetch and display EUR to INR exchange rate
                try {
                    const rateResponse = await axios.get(`${this.apiBase}/exchange-rate/EUR/INR`);
                    this.exchangeRate = rateResponse.data.rate;
                    this.updateExchangeRateDisplay(this.exchangeRate);
                } catch (e) {
                    console.error('Failed to fetch exchange rate:', e);
                }

                return response.data;
            }

            async fetchFamilyPortfolio() {
                // Fetch all accounts from all brokers and combine them
                const allHoldings = [];
                let totalValue = 0;
                let totalInvestment = 0;
                let totalPnl = 0;
                let totalFreeCash = 0;

                // Fetch Zerodha accounts
                for (const account of this.accounts.zerodha || []) {
                    try {
                        const url = `${this.apiBase}/portfolio/zerodha?currency=${this.currentCurrency}&account=${account}`;
                        const response = await axios.get(url);
                        const data = response.data;

                        // Add broker and account info to holdings
                        data.holdings.forEach(holding => {
                            allHoldings.push({
                                ...holding,
                                broker: 'zerodha',
                                account: account
                            });
                        });

                        totalValue += data.total_value;
                        totalInvestment += data.total_investment;
                        totalPnl += data.total_pnl;
                        totalFreeCash += data.free_cash || 0;
                    } catch (error) {
                        console.error(`Failed to fetch Zerodha account ${account}:`, error);
                    }
                }

                // Fetch Trading212 accounts
                for (const account of this.accounts.trading212 || []) {
                    try {
                        const url = `${this.apiBase}/portfolio/trading212?currency=${this.currentCurrency}&account=${account}`;
                        const response = await axios.get(url);
                        const data = response.data;

                        // Add broker and account info to holdings
                        data.holdings.forEach(holding => {
                            allHoldings.push({
                                ...holding,
                                broker: 'trading212',
                                account: account
                            });
                        });

                        totalValue += data.total_value;
                        totalInvestment += data.total_investment;
                        totalPnl += data.total_pnl;
                        totalFreeCash += data.free_cash || 0;
                    } catch (error) {
                        console.error(`Failed to fetch Trading212 account ${account}:`, error);
                    }
                }

                const totalPnlPercentage = totalInvestment > 0 ? (totalPnl / totalInvestment * 100) : 0;

                return {
                    broker: 'family',
                    total_value: totalValue,
                    total_investment: totalInvestment,
                    total_pnl: totalPnl,
                    total_pnl_percentage: totalPnlPercentage,
                    holdings: allHoldings,
                    last_updated: new Date().toISOString(),
                    free_cash: totalFreeCash,
                    is_cached: false
                };
            }

            updateExchangeRateDisplay(rate) {
                const displayElement = document.getElementById('exchangeRateDisplay');
                const valueElement = document.getElementById('exchangeRateValue');

                if (rate && displayElement && valueElement) {
                    valueElement.textContent = rate.toFixed(2);
                    displayElement.style.display = 'block';
                } else if (displayElement) {
                    displayElement.style.display = 'none';
                }
            }

            updateCacheIndicator(isCached) {
                const cacheIndicator = document.getElementById('cacheIndicator');

                if (cacheIndicator) {
                    if (isCached) {
                        cacheIndicator.style.display = 'block';
                        cacheIndicator.innerHTML = 'üì¶ Cached Data (API Unavailable)';
                    } else {
                        cacheIndicator.style.display = 'none';
                    }
                }
            }

            async fetchAnalysis() {
                const response = await axios.post(`${this.apiBase}/analyze`, {
                    broker: this.currentBroker,
                    include_recommendations: true,
                    include_risk_analysis: true
                });
                return response.data;
            }
            
            updateMetrics(portfolioData) {
                const currencySymbol = this.currentCurrency === 'INR' ? '‚Çπ' : '‚Ç¨';
                const metricsGrid = document.getElementById('metricsGrid');

                // Build metrics HTML
                let metricsHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${currencySymbol}${portfolioData.total_value.toLocaleString('en-IN', {maximumFractionDigits: 2})}</div>
                        <div class="metric-label">üíº Total Value (${this.currentCurrency})</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${portfolioData.total_pnl >= 0 ? 'positive' : 'negative'}">
                            ${portfolioData.total_pnl >= 0 ? 'üìà +' : 'üìâ '}${currencySymbol}${Math.abs(portfolioData.total_pnl).toLocaleString('en-IN', {maximumFractionDigits: 2})}
                        </div>
                        <div class="metric-label">Total P&L</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${portfolioData.total_pnl_percentage >= 0 ? 'positive' : 'negative'}">
                            ${portfolioData.total_pnl_percentage >= 0 ? '‚úÖ +' : '‚ùå '}${Math.abs(portfolioData.total_pnl_percentage).toFixed(2)}%
                        </div>
                        <div class="metric-label">Return %</div>
                    </div>`;

                // Always show free cash card (prominently like Trading212)
                const freeCash = portfolioData.free_cash || 0;
                metricsHTML += `
                    <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="metric-value" style="color: white;">üíµ ${currencySymbol}${freeCash.toLocaleString('en-IN', {maximumFractionDigits: 2})}</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Available Cash</div>
                    </div>`;

                metricsHTML += `
                    <div class="metric-card">
                        <div class="metric-value">üìä ${portfolioData.holdings.length}</div>
                        <div class="metric-label">Holdings</div>
                    </div>
                `;

                metricsGrid.innerHTML = metricsHTML;
            }
            
            async updateCharts(portfolioData) {
                // Portfolio Value Chart
                this.createPortfolioValueChart(portfolioData);
                
                // Asset Allocation Chart
                this.createAssetAllocationChart(portfolioData);
                
                // P&L Chart
                this.createPnLChart(portfolioData);
                
                // Risk vs Return Chart
                this.createRiskReturnChart(portfolioData);
                
                // Top Holdings Chart
                this.createTopHoldingsChart(portfolioData);
                
                // Metrics Dashboard
                this.createMetricsDashboard(portfolioData);
            }
            
            createPortfolioValueChart(portfolioData) {
                const currencySymbol = this.currentCurrency === 'INR' ? '‚Çπ' : '‚Ç¨';
                const data = [{
                    x: ['Current'],
                    y: [portfolioData.total_value],
                    type: 'bar',
                    name: 'Portfolio Value',
                    marker: { color: '#667eea' },
                    text: [`${currencySymbol}${portfolioData.total_value.toLocaleString('en-IN', {maximumFractionDigits: 2})}`],
                    textposition: 'outside'
                }];

                const layout = {
                    title: '',
                    xaxis: { title: '' },
                    yaxis: {
                        title: `Value (${currencySymbol})`,
                        tickformat: ',.0f'
                    },
                    showlegend: false
                };

                Plotly.newPlot('portfolioValueChart', data, layout);
            }
            
            createAssetAllocationChart(portfolioData) {
                const assetTypes = {};
                portfolioData.holdings.forEach(holding => {
                    const type = holding.asset_type || 'equity';
                    assetTypes[type] = (assetTypes[type] || 0) + holding.current_value;
                });
                
                const data = [{
                    labels: Object.keys(assetTypes),
                    values: Object.values(assetTypes),
                    type: 'pie',
                    hole: 0.3
                }];
                
                const layout = {
                    title: 'Asset Allocation'
                };
                
                Plotly.newPlot('assetAllocationChart', data, layout);
            }
            
            createPnLChart(portfolioData) {
                const currencySymbol = this.currentCurrency === 'INR' ? '‚Çπ' : '‚Ç¨';
                const data = [{
                    x: ['Total P&L'],
                    y: [portfolioData.total_pnl],
                    type: 'bar',
                    marker: {
                        color: portfolioData.total_pnl >= 0 ? '#27ae60' : '#e74c3c'
                    },
                    text: [`${currencySymbol}${portfolioData.total_pnl.toLocaleString('en-IN', {maximumFractionDigits: 2})}`],
                    textposition: 'outside'
                }];

                const layout = {
                    title: '',
                    xaxis: { title: '' },
                    yaxis: {
                        title: `P&L (${currencySymbol})`,
                        tickformat: ',.0f'
                    },
                    showlegend: false
                };

                Plotly.newPlot('pnlChart', data, layout);
            }
            
            createRiskReturnChart(portfolioData) {
                const x = [];
                const y = [];
                const text = [];
                const size = [];
                
                portfolioData.holdings.forEach(holding => {
                    x.push(Math.random() * 0.3); // Simulated risk
                    y.push(Math.random() * 0.2); // Simulated return
                    text.push(holding.symbol);
                    size.push(holding.current_value / portfolioData.total_value * 50);
                });
                
                const data = [{
                    x: x,
                    y: y,
                    mode: 'markers',
                    text: text,
                    marker: {
                        size: size,
                        color: y,
                        colorscale: 'Viridis',
                        showscale: true
                    }
                }];
                
                const layout = {
                    title: 'Risk vs Return',
                    xaxis: { title: 'Risk (Volatility)' },
                    yaxis: { title: 'Return Rate' }
                };
                
                Plotly.newPlot('riskReturnChart', data, layout);
            }
            
            createTopHoldingsChart(portfolioData) {
                const currencySymbol = this.currentCurrency === 'INR' ? '‚Çπ' : '‚Ç¨';
                const sortedHoldings = portfolioData.holdings
                    .sort((a, b) => b.current_value - a.current_value)
                    .slice(0, 10);

                const data = [{
                    x: sortedHoldings.map(h => h.symbol),
                    y: sortedHoldings.map(h => h.current_value),
                    type: 'bar',
                    marker: {
                        color: '#764ba2',
                        opacity: 0.8
                    },
                    text: sortedHoldings.map(h => `${currencySymbol}${h.current_value.toLocaleString('en-IN', {maximumFractionDigits: 0})}`),
                    textposition: 'outside'
                }];

                const layout = {
                    title: '',
                    xaxis: { title: 'Stock Symbol' },
                    yaxis: {
                        title: `Value (${currencySymbol})`,
                        tickformat: ',.0f'
                    },
                    showlegend: false
                };

                Plotly.newPlot('topHoldingsChart', data, layout);
            }
            
            createMetricsDashboard(portfolioData) {
                const data = [{
                    type: 'indicator',
                    mode: 'number+delta',
                    value: portfolioData.total_pnl_percentage,
                    title: { text: 'Total Return (%)' },
                    delta: { reference: 0 }
                }];
                
                const layout = {
                    title: 'Portfolio Metrics'
                };
                
                Plotly.newPlot('metricsDashboard', data, layout);
            }
            
            updateRecommendations(recommendations) {
                const recommendationsDiv = document.getElementById('recommendations');
                const recommendationsList = document.getElementById('recommendationsList');
                
                if (recommendations && recommendations.length > 0) {
                    recommendationsList.innerHTML = recommendations
                        .map(rec => `<li>${rec}</li>`)
                        .join('');
                    recommendationsDiv.style.display = 'block';
                } else {
                    recommendationsDiv.style.display = 'none';
                }
            }
            
            showLoading(show) {
                document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            }
            
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = '‚ùå ' + message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = '‚úÖ ' + message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new FinancialDashboard();
        });
    </script>
</body>
</html>

